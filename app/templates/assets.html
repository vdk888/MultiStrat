{% extends "layout.html" %}

{% block title %}Assets | Portfolio Management System{% endblock %}

{% block content %}
<!-- Page Title & Controls -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Assets</h1>
    <div class="d-flex">
        <button id="refresh-assets" class="btn btn-sm btn-outline-secondary me-2">
            <i class="fas fa-sync-alt me-1"></i> Refresh
        </button>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#add-asset-modal">
            <i class="fas fa-plus me-1"></i> Add Asset
        </button>
    </div>
</div>

<!-- Asset Classes -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Asset Classes</h5>
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#add-asset-class-modal">
            <i class="fas fa-plus me-1"></i> Add Asset Class
        </button>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Assets</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="asset-classes-table">
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading asset classes...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Assets List -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Assets</h5>
        <div>
            <div class="input-group">
                <select id="asset-class-filter" class="form-select form-select-sm" style="width: 150px;">
                    <option value="">All Asset Classes</option>
                </select>
                <button id="filter-assets" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Name</th>
                        <th>Asset Class</th>
                        <th>Yahoo Finance</th>
                        <th>Alpaca</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="assets-table">
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading assets...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Asset Class Modal -->
<div class="modal fade" id="add-asset-class-modal" tabindex="-1" aria-labelledby="addAssetClassModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAssetClassModalLabel">Add Asset Class</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="add-asset-class-form">
                    <div class="mb-3">
                        <label for="asset-class-name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="asset-class-name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="asset-class-description" class="form-label">Description</label>
                        <textarea class="form-control" id="asset-class-description" name="description" rows="3"></textarea>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Add Asset Class</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Asset Modal -->
<div class="modal fade" id="add-asset-modal" tabindex="-1" aria-labelledby="addAssetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAssetModalLabel">Add Asset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="add-asset-form">
                    <div class="mb-3">
                        <label for="asset-symbol" class="form-label">Symbol</label>
                        <input type="text" class="form-control" id="asset-symbol" name="symbol" required>
                    </div>
                    <div class="mb-3">
                        <label for="asset-name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="asset-name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="asset-class-id" class="form-label">Asset Class</label>
                        <select class="form-select" id="asset-class-id" name="asset_class_id" required>
                            <option value="" selected disabled>Select Asset Class</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="asset-yfinance" class="form-label">Yahoo Finance Symbol</label>
                        <input type="text" class="form-control" id="asset-yfinance" name="yfinance_symbol">
                        <div class="form-text">Leave empty to use the same as the main symbol</div>
                    </div>
                    <div class="mb-3">
                        <label for="asset-alpaca" class="form-label">Alpaca Symbol</label>
                        <input type="text" class="form-control" id="asset-alpaca" name="alpaca_symbol">
                        <div class="form-text">Leave empty to use the same as the main symbol</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="asset-is-active" name="is_active" checked>
                            <label class="form-check-label" for="asset-is-active">Active</label>
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Add Asset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Asset Details Modal -->
<div class="modal fade" id="asset-details-modal" tabindex="-1" aria-labelledby="assetDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assetDetailsModalLabel">Asset Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="asset-details-content">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading asset details...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadAssetClasses();
        loadAssets();
        
        // Refresh buttons
        document.getElementById('refresh-assets')?.addEventListener('click', function() {
            loadAssetClasses();
            loadAssets();
        });
        
        // Filter assets by class
        document.getElementById('filter-assets')?.addEventListener('click', function() {
            loadAssets();
        });
        
        // Add asset class form
        document.getElementById('add-asset-class-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            addAssetClass(this);
        });
        
        // Add asset form
        document.getElementById('add-asset-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            addAsset(this);
        });
    });
    
    // Load asset classes
    function loadAssetClasses() {
        fetch('/api/v1/assets/classes')
            .then(response => response.json())
            .then(data => {
                renderAssetClasses(data);
                populateAssetClassDropdowns(data);
            })
            .catch(error => {
                console.error('Error loading asset classes:', error);
                showErrorMessage('Failed to load asset classes.');
            });
    }
    
    // Render asset classes table
    function renderAssetClasses(assetClasses) {
        const tableBody = document.getElementById('asset-classes-table');
        if (!tableBody) return;
        
        if (!assetClasses || assetClasses.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4">
                        <div class="text-muted">No asset classes found</div>
                    </td>
                </tr>
            `;
            return;
        }
        
        const rows = assetClasses.map(assetClass => `
            <tr>
                <td>${assetClass.id}</td>
                <td>${assetClass.name}</td>
                <td>${assetClass.description || '-'}</td>
                <td><span class="badge bg-primary">${assetClass.assets?.length || 0}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-asset-class" data-id="${assetClass.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary edit-asset-class" data-id="${assetClass.id}">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `).join('');
        
        tableBody.innerHTML = rows;
        
        // Add event listeners
        document.querySelectorAll('.view-asset-class').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                viewAssetClass(id);
            });
        });
        
        document.querySelectorAll('.edit-asset-class').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                editAssetClass(id);
            });
        });
    }
    
    // Populate asset class dropdowns
    function populateAssetClassDropdowns(assetClasses) {
        const filterDropdown = document.getElementById('asset-class-filter');
        const formDropdown = document.getElementById('asset-class-id');
        
        if (filterDropdown) {
            // Keep the first "All" option
            filterDropdown.innerHTML = '<option value="">All Asset Classes</option>';
            
            assetClasses.forEach(assetClass => {
                const option = document.createElement('option');
                option.value = assetClass.id;
                option.textContent = assetClass.name;
                filterDropdown.appendChild(option);
            });
        }
        
        if (formDropdown) {
            // Keep the first placeholder option
            formDropdown.innerHTML = '<option value="" selected disabled>Select Asset Class</option>';
            
            assetClasses.forEach(assetClass => {
                const option = document.createElement('option');
                option.value = assetClass.id;
                option.textContent = assetClass.name;
                formDropdown.appendChild(option);
            });
        }
    }
    
    // Load assets
    function loadAssets() {
        const assetClassFilter = document.getElementById('asset-class-filter')?.value;
        let url = '/api/v1/assets';
        
        if (assetClassFilter) {
            url += `?asset_class_id=${assetClassFilter}`;
        }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                renderAssets(data);
            })
            .catch(error => {
                console.error('Error loading assets:', error);
                showErrorMessage('Failed to load assets.');
            });
    }
    
    // Render assets table
    function renderAssets(assets) {
        const tableBody = document.getElementById('assets-table');
        if (!tableBody) return;
        
        if (!assets || assets.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="text-muted">No assets found</div>
                    </td>
                </tr>
            `;
            return;
        }
        
        const rows = assets.map(asset => `
            <tr>
                <td><strong>${asset.symbol}</strong></td>
                <td>${asset.name}</td>
                <td>${asset.asset_class?.name || `Class ID: ${asset.asset_class_id}`}</td>
                <td>${asset.yfinance_symbol || asset.symbol}</td>
                <td>${asset.alpaca_symbol || asset.symbol}</td>
                <td>
                    <span class="badge ${asset.is_active ? 'bg-success' : 'bg-secondary'}">
                        ${asset.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-asset" data-id="${asset.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary edit-asset" data-id="${asset.id}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-asset" data-id="${asset.id}" data-symbol="${asset.symbol}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
        
        tableBody.innerHTML = rows;
        
        // Add event listeners
        document.querySelectorAll('.view-asset').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                viewAsset(id);
            });
        });
        
        document.querySelectorAll('.edit-asset').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                editAsset(id);
            });
        });
        
        document.querySelectorAll('.delete-asset').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const symbol = this.getAttribute('data-symbol');
                deleteAsset(id, symbol);
            });
        });
    }
    
    // Add asset class
    function addAssetClass(form) {
        const formData = new FormData(form);
        const assetClassData = {
            name: formData.get('name'),
            description: formData.get('description') || ''
        };
        
        fetch('/api/v1/assets/classes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(assetClassData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.detail || 'Failed to add asset class');
                });
            }
            return response.json();
        })
        .then(data => {
            showSuccessMessage('Asset class added successfully!');
            form.reset();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('add-asset-class-modal'));
            if (modal) {
                modal.hide();
            }
            
            // Reload asset classes
            loadAssetClasses();
        })
        .catch(error => {
            console.error('Error adding asset class:', error);
            showErrorMessage(error.message);
        });
    }
    
    // Add asset
    function addAsset(form) {
        const formData = new FormData(form);
        const assetData = {
            symbol: formData.get('symbol'),
            name: formData.get('name'),
            asset_class_id: parseInt(formData.get('asset_class_id')),
            yfinance_symbol: formData.get('yfinance_symbol') || null,
            alpaca_symbol: formData.get('alpaca_symbol') || null,
            is_active: formData.get('is_active') === 'on'
        };
        
        fetch('/api/v1/assets', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(assetData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.detail || 'Failed to add asset');
                });
            }
            return response.json();
        })
        .then(data => {
            showSuccessMessage('Asset added successfully!');
            form.reset();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('add-asset-modal'));
            if (modal) {
                modal.hide();
            }
            
            // Reload assets
            loadAssets();
        })
        .catch(error => {
            console.error('Error adding asset:', error);
            showErrorMessage(error.message);
        });
    }
    
    // View asset class
    function viewAssetClass(id) {
        // To be implemented
        alert('View asset class ' + id);
    }
    
    // Edit asset class
    function editAssetClass(id) {
        // To be implemented
        alert('Edit asset class ' + id);
    }
    
    // View asset
    function viewAsset(id) {
        const modal = new bootstrap.Modal(document.getElementById('asset-details-modal'));
        const contentContainer = document.getElementById('asset-details-content');
        
        // Show loading
        contentContainer.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading asset details...</p>
            </div>
        `;
        
        modal.show();
        
        // Fetch asset data
        fetch(`/api/v1/assets/${id}`)
            .then(response => response.json())
            .then(asset => {
                // Fetch market data
                return fetch(`/api/v1/assets/${id}/market-data?days=30&interval=1d`)
                    .then(response => response.json())
                    .then(marketData => {
                        return { asset, marketData };
                    })
                    .catch(() => {
                        return { asset, marketData: null };
                    });
            })
            .then(data => {
                const { asset, marketData } = data;
                
                let assetDetailsHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <h4>${asset.symbol} - ${asset.name}</h4>
                            <div class="mb-4">
                                <span class="badge ${asset.is_active ? 'bg-success' : 'bg-secondary'}">
                                    ${asset.is_active ? 'Active' : 'Inactive'}
                                </span>
                                <span class="badge bg-info">${asset.asset_class?.name || `Class ID: ${asset.asset_class_id}`}</span>
                            </div>
                            
                            <h6>Details</h6>
                            <table class="table">
                                <tr>
                                    <th>ID</th>
                                    <td>${asset.id}</td>
                                </tr>
                                <tr>
                                    <th>Symbol</th>
                                    <td>${asset.symbol}</td>
                                </tr>
                                <tr>
                                    <th>Yahoo Finance Symbol</th>
                                    <td>${asset.yfinance_symbol || asset.symbol}</td>
                                </tr>
                                <tr>
                                    <th>Alpaca Symbol</th>
                                    <td>${asset.alpaca_symbol || asset.symbol}</td>
                                </tr>
                                <tr>
                                    <th>Created At</th>
                                    <td>${new Date(asset.created_at).toLocaleString()}</td>
                                </tr>
                                <tr>
                                    <th>Updated At</th>
                                    <td>${new Date(asset.updated_at).toLocaleString()}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                `;
                
                if (marketData && marketData.length > 0) {
                    assetDetailsHtml += `
                            <h6>Market Data (Last 30 Days)</h6>
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="asset-price-chart"></canvas>
                            </div>
                    `;
                } else {
                    assetDetailsHtml += `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                No market data available for this asset.
                            </div>
                    `;
                }
                
                assetDetailsHtml += `
                        </div>
                    </div>
                    <div class="d-flex justify-content-end mt-3">
                        <button class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Close</button>
                        <button class="btn btn-outline-primary edit-asset-btn" data-id="${asset.id}">
                            <i class="fas fa-edit me-1"></i> Edit Asset
                        </button>
                    </div>
                `;
                
                contentContainer.innerHTML = assetDetailsHtml;
                
                // Add event listener for edit button
                document.querySelector('.edit-asset-btn')?.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    modal.hide();
                    editAsset(id);
                });
                
                // Create price chart if market data is available
                if (marketData && marketData.length > 0) {
                    const ctx = document.getElementById('asset-price-chart').getContext('2d');
                    
                    const dates = marketData.map(item => new Date(item.timestamp));
                    const prices = marketData.map(item => item.close);
                    
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: `${asset.symbol} Price`,
                                data: prices,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'day'
                                    }
                                },
                                y: {
                                    beginAtZero: false
                                }
                            }
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error loading asset details:', error);
                contentContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Failed to load asset details. Please try again later.
                    </div>
                `;
            });
    }
    
    // Edit asset
    function editAsset(id) {
        // To be implemented
        alert('Edit asset ' + id);
    }
    
    // Delete asset
    function deleteAsset(id, symbol) {
        if (confirm(`Are you sure you want to delete asset ${symbol}?`)) {
            fetch(`/api/v1/assets/${id}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.detail || 'Failed to delete asset');
                    });
                }
                return response.json();
            })
            .then(data => {
                showSuccessMessage(`Asset ${symbol} deleted successfully!`);
                
                // Reload assets
                loadAssets();
            })
            .catch(error => {
                console.error('Error deleting asset:', error);
                showErrorMessage(error.message);
            });
        }
    }
</script>
{% endblock %}
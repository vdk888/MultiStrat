{% extends "layout.html" %}

{% block title %}Strategies | Portfolio Management System{% endblock %}

{% block content %}
<!-- Page Title & Controls -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Trading Strategies</h1>
    <div class="d-flex">
        <button id="refresh-strategies" class="btn btn-sm btn-outline-secondary me-2">
            <i class="fas fa-sync-alt me-1"></i> Refresh
        </button>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#create-strategy-modal">
            <i class="fas fa-plus me-1"></i> New Strategy
        </button>
    </div>
</div>

<!-- Strategies List -->
<div class="row" id="strategies-container">
    <div class="col-12">
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading strategies...</p>
        </div>
    </div>
</div>

<!-- Create Strategy Modal -->
<div class="modal fade" id="create-strategy-modal" tabindex="-1" aria-labelledby="createStrategyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createStrategyModalLabel">Create New Strategy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="create-strategy-form">
                    <div class="mb-3">
                        <label for="strategy-template" class="form-label">Strategy Template</label>
                        <select class="form-select" id="strategy-template">
                            <option value="" selected>Custom Strategy</option>
                            <option value="momentum">Momentum Strategy</option>
                            <option value="mean_reversion">Mean Reversion Strategy</option>
                            <option value="adaptive">Adaptive Strategy</option>
                        </select>
                        <div class="form-text">Select a template to start with predefined parameters or create a custom strategy</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="strategy-name" class="form-label">Strategy Name</label>
                        <input type="text" class="form-control" id="strategy-name" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="strategy-description" class="form-label">Description</label>
                        <textarea class="form-control" id="strategy-description" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="asset-class-id" class="form-label">Asset Class</label>
                        <select class="form-select" id="asset-class-id" name="asset_class_id" required>
                            <option value="" selected disabled>Select Asset Class</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                        <div class="form-text">The asset class this strategy is designed for</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="strategy-is-active" name="is_active" checked>
                            <label class="form-check-label" for="strategy-is-active">Active</label>
                        </div>
                    </div>
                    
                    <h5 class="mt-4 mb-3">Strategy Parameters</h5>
                    <div id="parameters-container">
                        <!-- Default parameters will be added here -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="param-macd-fast" class="form-label">MACD Fast Period</label>
                                <input type="number" class="form-control" id="param-macd-fast" name="parameters.macd_fast" value="12" min="1" max="50">
                            </div>
                            <div class="col-md-6">
                                <label for="param-macd-slow" class="form-label">MACD Slow Period</label>
                                <input type="number" class="form-control" id="param-macd-slow" name="parameters.macd_slow" value="26" min="2" max="100">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="param-macd-signal" class="form-label">MACD Signal Period</label>
                                <input type="number" class="form-control" id="param-macd-signal" name="parameters.macd_signal" value="9" min="1" max="50">
                            </div>
                            <div class="col-md-6">
                                <label for="param-rsi-period" class="form-label">RSI Period</label>
                                <input type="number" class="form-control" id="param-rsi-period" name="parameters.rsi_period" value="14" min="2" max="50">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="param-stochastic-k" class="form-label">Stochastic K Period</label>
                                <input type="number" class="form-control" id="param-stochastic-k" name="parameters.stochastic_k_period" value="14" min="1" max="50">
                            </div>
                            <div class="col-md-6">
                                <label for="param-stochastic-d" class="form-label">Stochastic D Period</label>
                                <input type="number" class="form-control" id="param-stochastic-d" name="parameters.stochastic_d_period" value="3" min="1" max="20">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="param-buy-up-lim" class="form-label">Buy Upper Limit</label>
                                <input type="number" class="form-control" id="param-buy-up-lim" name="parameters.buy_up_lim" value="-2.0" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="param-sell-down-lim" class="form-label">Sell Lower Limit</label>
                                <input type="number" class="form-control" id="param-sell-down-lim" name="parameters.sell_down_lim" value="2.0" step="0.1">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="param-reactivity" class="form-label">Reactivity</label>
                                <input type="number" class="form-control" id="param-reactivity" name="parameters.reactivity" value="1.0" min="0.1" max="5.0" step="0.1">
                                <div class="form-text">Controls how quickly the strategy responds to market changes</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-primary">Create Strategy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Strategy Details Modal -->
<div class="modal fade" id="strategy-details-modal" tabindex="-1" aria-labelledby="strategyDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="strategyDetailsModalLabel">Strategy Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="strategy-details-content">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading strategy details...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Optimization History Modal -->
<div class="modal fade" id="optimization-history-modal" tabindex="-1" aria-labelledby="optimizationHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="optimizationHistoryModalLabel">Optimization History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="optimization-history-content">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading optimization history...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
        // Load strategies
        loadStrategies();
        
        // Load asset classes for dropdown
        loadAssetClasses();
        
        // Set up event listeners
        document.getElementById('refresh-strategies')?.addEventListener('click', loadStrategies);
        
        // Strategy template selection
        document.getElementById('strategy-template')?.addEventListener('change', function() {
            const templateId = this.value;
            if (templateId) {
                loadStrategyTemplate(templateId);
            } else {
                // Reset to default parameters
                resetParameters();
            }
        });
        
        // Strategy creation form
        document.getElementById('create-strategy-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            createStrategy(this);
        });
    });
    
    // Load strategies
    function loadStrategies() {
        const container = document.getElementById('strategies-container');
        if (!container) return;
        
        // Show loading
        container.innerHTML = `
            <div class="col-12">
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading strategies...</p>
                </div>
            </div>
        `;
        
        // Fetch strategies from API
        fetch('/api/v1/strategies')
            .then(response => response.json())
            .then(strategies => {
                renderStrategies(strategies);
            })
            .catch(error => {
                console.error('Error loading strategies:', error);
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Failed to load strategies. Please try again later.
                        </div>
                    </div>
                `;
            });
    }
    
    // Render strategies
    function renderStrategies(strategies) {
        const container = document.getElementById('strategies-container');
        if (!container) return;
        
        if (!strategies || strategies.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No strategies found. Create a strategy to get started.
                    </div>
                </div>
            `;
            return;
        }
        
        // Clear container
        container.innerHTML = '';
        
        // Create HTML for each strategy
        strategies.forEach(strategy => {
            const card = document.createElement('div');
            card.className = 'col-lg-4 col-md-6 mb-4';
            
            // Determine parameter count
            const paramCount = strategy.parameters ? Object.keys(strategy.parameters).length : 0;
            
            card.innerHTML = `
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <h5 class="card-title mb-0">${strategy.name}</h5>
                            <span class="badge ${strategy.is_active ? 'bg-success' : 'bg-secondary'}">
                                ${strategy.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                        <div class="text-muted mb-3">${strategy.description || 'No description provided'}</div>
                        <div class="mb-3">
                            <span class="badge bg-info">Asset Class: ${strategy.asset_class?.name || 'Not specified'}</span>
                            <span class="badge bg-secondary">${paramCount} Parameters</span>
                        </div>
                        
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-muted small">Last optimized:</div>
                                <div class="text-end small text-primary">
                                    <span class="view-optimizations cursor-pointer" data-strategy-id="${strategy.id}">
                                        <i class="fas fa-history me-1"></i> View History
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-0 p-3">
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-sm btn-outline-primary view-strategy" data-strategy-id="${strategy.id}">
                                <i class="fas fa-eye me-1"></i> Details
                            </button>
                            <button class="btn btn-sm btn-outline-info optimize-strategy" data-strategy-id="${strategy.id}">
                                <i class="fas fa-cogs me-1"></i> Optimize
                            </button>
                            <button class="btn btn-sm btn-outline-secondary edit-strategy" data-strategy-id="${strategy.id}">
                                <i class="fas fa-edit me-1"></i> Edit
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
        
        // Add event listeners for action buttons
        document.querySelectorAll('.view-strategy').forEach(button => {
            button.addEventListener('click', function() {
                const strategyId = this.getAttribute('data-strategy-id');
                viewStrategy(strategyId);
            });
        });
        
        document.querySelectorAll('.edit-strategy').forEach(button => {
            button.addEventListener('click', function() {
                const strategyId = this.getAttribute('data-strategy-id');
                editStrategy(strategyId);
            });
        });
        
        document.querySelectorAll('.optimize-strategy').forEach(button => {
            button.addEventListener('click', function() {
                const strategyId = this.getAttribute('data-strategy-id');
                window.location.href = `/optimization?strategy_id=${strategyId}`;
            });
        });
        
        document.querySelectorAll('.view-optimizations').forEach(element => {
            element.addEventListener('click', function() {
                const strategyId = this.getAttribute('data-strategy-id');
                viewOptimizationHistory(strategyId);
            });
        });
    }
    
    // Load asset classes for dropdown
    function loadAssetClasses() {
        fetch('/api/v1/assets/classes')
            .then(response => response.json())
            .then(data => {
                const dropdown = document.getElementById('asset-class-id');
                if (!dropdown) return;
                
                // Keep the first placeholder option
                dropdown.innerHTML = '<option value="" selected disabled>Select Asset Class</option>';
                
                // Add options for each asset class
                data.forEach(assetClass => {
                    const option = document.createElement('option');
                    option.value = assetClass.id;
                    option.textContent = assetClass.name;
                    dropdown.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading asset classes:', error);
                showErrorMessage('Failed to load asset classes.');
            });
    }
    
    // Load strategy template
    function loadStrategyTemplate(templateId) {
        fetch(`/api/v1/strategies/templates/${templateId}`)
            .then(response => response.json())
            .then(template => {
                // Set name and description if they're empty
                const nameInput = document.getElementById('strategy-name');
                const descInput = document.getElementById('strategy-description');
                
                if (nameInput && (!nameInput.value || nameInput.value === '')) {
                    nameInput.value = template.name || '';
                }
                
                if (descInput && (!descInput.value || descInput.value === '')) {
                    descInput.value = template.description || '';
                }
                
                // Set parameters
                if (template.parameters) {
                    for (const [key, value] of Object.entries(template.parameters)) {
                        const input = document.querySelector(`[name="parameters.${key}"]`);
                        if (input) {
                            input.value = value;
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error loading strategy template:', error);
                showErrorMessage('Failed to load strategy template.');
            });
    }
    
    // Reset parameters to default
    function resetParameters() {
        // Reset each parameter input to its default value
        document.getElementById('param-macd-fast').value = '12';
        document.getElementById('param-macd-slow').value = '26';
        document.getElementById('param-macd-signal').value = '9';
        document.getElementById('param-rsi-period').value = '14';
        document.getElementById('param-stochastic-k').value = '14';
        document.getElementById('param-stochastic-d').value = '3';
        document.getElementById('param-buy-up-lim').value = '-2.0';
        document.getElementById('param-sell-down-lim').value = '2.0';
        document.getElementById('param-reactivity').value = '1.0';
    }
    
    // Create strategy
    function createStrategy(form) {
        // Collect form data
        const formData = new FormData(form);
        
        // Basic strategy data
        const strategyData = {
            name: formData.get('name'),
            description: formData.get('description') || '',
            asset_class_id: parseInt(formData.get('asset_class_id')),
            is_active: formData.get('is_active') === 'on',
            parameters: {}
        };
        
        // Collect parameters
        for (const [key, value] of formData.entries()) {
            if (key.startsWith('parameters.')) {
                const paramName = key.replace('parameters.', '');
                // Convert numeric values
                const numValue = parseFloat(value);
                strategyData.parameters[paramName] = isNaN(numValue) ? value : numValue;
            }
        }
        
        // Create strategy via API
        fetch('/api/v1/strategies', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(strategyData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.detail || 'Failed to create strategy');
                });
            }
            return response.json();
        })
        .then(data => {
            showSuccessMessage('Strategy created successfully!');
            
            // Reset form
            form.reset();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('create-strategy-modal'));
            if (modal) {
                modal.hide();
            }
            
            // Reload strategies
            loadStrategies();
        })
        .catch(error => {
            console.error('Error creating strategy:', error);
            showErrorMessage(error.message);
        });
    }
    
    // View strategy details
    function viewStrategy(strategyId) {
        const modal = new bootstrap.Modal(document.getElementById('strategy-details-modal'));
        const contentContainer = document.getElementById('strategy-details-content');
        
        // Show loading
        contentContainer.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading strategy details...</p>
            </div>
        `;
        
        modal.show();
        
        // Fetch strategy data
        fetch(`/api/v1/strategies/${strategyId}`)
            .then(response => response.json())
            .then(strategy => {
                // Get latest optimization if available
                return fetch(`/api/v1/optimization/latest/${strategyId}`)
                    .then(response => {
                        if (!response.ok) {
                            return { strategy, optimization: null };
                        }
                        return response.json().then(optimization => {
                            return { strategy, optimization };
                        });
                    })
                    .catch(() => {
                        return { strategy, optimization: null };
                    });
            })
            .then(data => {
                const { strategy, optimization } = data;
                
                let parametersHtml = '';
                if (strategy.parameters && Object.keys(strategy.parameters).length > 0) {
                    parametersHtml = `
                        <h6 class="mt-4">Strategy Parameters</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Parameter</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    for (const [key, value] of Object.entries(strategy.parameters)) {
                        parametersHtml += `
                            <tr>
                                <td>${formatParamName(key)}</td>
                                <td>${formatParamValue(value)}</td>
                            </tr>
                        `;
                    }
                    
                    parametersHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    parametersHtml = `
                        <div class="alert alert-info mt-4">
                            <i class="fas fa-info-circle me-2"></i>
                            No parameters defined for this strategy.
                        </div>
                    `;
                }
                
                let optimizationHtml = '';
                if (optimization) {
                    optimizationHtml = `
                        <h6 class="mt-4">Latest Optimization</h6>
                        <div class="card border-0 bg-light mb-3">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <div class="text-muted small">Date:</div>
                                            <div>${new Date(optimization.timestamp).toLocaleString()}</div>
                                        </div>
                                        <div class="mb-2">
                                            <div class="text-muted small">Sharpe Ratio:</div>
                                            <div class="text-primary fw-bold">${optimization.metrics?.sharpe_ratio?.toFixed(2) || 'N/A'}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <div class="text-muted small">Total Return:</div>
                                            <div>${optimization.metrics?.total_return?.toFixed(2) || 'N/A'}%</div>
                                        </div>
                                        <div class="mb-2">
                                            <div class="text-muted small">Max Drawdown:</div>
                                            <div>${optimization.metrics?.max_drawdown?.toFixed(2) || 'N/A'}%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    optimizationHtml = `
                        <div class="alert alert-info mt-4">
                            <i class="fas fa-info-circle me-2"></i>
                            No optimization history found for this strategy.
                        </div>
                    `;
                }
                
                const detailsHtml = `
                    <div class="row">
                        <div class="col-md-12">
                            <h4>${strategy.name}</h4>
                            <div class="mb-4">
                                <span class="badge ${strategy.is_active ? 'bg-success' : 'bg-secondary'}">
                                    ${strategy.is_active ? 'Active' : 'Inactive'}
                                </span>
                                <span class="badge bg-info">Asset Class: ${strategy.asset_class?.name || 'Not specified'}</span>
                            </div>
                            
                            <div class="mb-4">
                                <h6>Description</h6>
                                <p>${strategy.description || 'No description provided.'}</p>
                            </div>
                            
                            ${parametersHtml}
                            
                            ${optimizationHtml}
                            
                            <div class="d-flex justify-content-end mt-4">
                                <button class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Close</button>
                                <button class="btn btn-outline-info optimize-btn me-2" data-strategy-id="${strategy.id}">
                                    <i class="fas fa-cogs me-1"></i> Optimize
                                </button>
                                <button class="btn btn-outline-primary edit-strategy-btn" data-strategy-id="${strategy.id}">
                                    <i class="fas fa-edit me-1"></i> Edit Strategy
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                contentContainer.innerHTML = detailsHtml;
                
                // Add event listeners
                document.querySelector('.optimize-btn')?.addEventListener('click', function() {
                    const id = this.getAttribute('data-strategy-id');
                    window.location.href = `/optimization?strategy_id=${id}`;
                });
                
                document.querySelector('.edit-strategy-btn')?.addEventListener('click', function() {
                    const id = this.getAttribute('data-strategy-id');
                    modal.hide();
                    editStrategy(id);
                });
            })
            .catch(error => {
                console.error('Error loading strategy details:', error);
                contentContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Failed to load strategy details. Please try again later.
                    </div>
                `;
            });
    }
    
    // Edit strategy
    function editStrategy(strategyId) {
        // Redirect to edit page or implement in-place editing
        alert('Edit strategy ' + strategyId + ' (Not implemented yet)');
    }
    
    // View optimization history
    function viewOptimizationHistory(strategyId) {
        const modal = new bootstrap.Modal(document.getElementById('optimization-history-modal'));
        const contentContainer = document.getElementById('optimization-history-content');
        
        // Show loading
        contentContainer.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading optimization history...</p>
            </div>
        `;
        
        modal.show();
        
        // Fetch optimization history
        fetch(`/api/v1/optimization/results/${strategyId}`)
            .then(response => response.json())
            .then(optimizations => {
                if (!optimizations || optimizations.length === 0) {
                    contentContainer.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No optimization history found for this strategy.
                        </div>
                    `;
                    return;
                }
                
                // Create HTML for optimization history
                let historyHtml = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Sharpe Ratio</th>
                                    <th>Total Return</th>
                                    <th>Max Drawdown</th>
                                    <th>Win Rate</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                optimizations.forEach(opt => {
                    historyHtml += `
                        <tr>
                            <td>${new Date(opt.timestamp).toLocaleString()}</td>
                            <td>${opt.metrics?.sharpe_ratio?.toFixed(2) || 'N/A'}</td>
                            <td>${opt.metrics?.total_return?.toFixed(2) || 'N/A'}%</td>
                            <td>${opt.metrics?.max_drawdown?.toFixed(2) || 'N/A'}%</td>
                            <td>${opt.metrics?.win_rate?.toFixed(2) || 'N/A'}%</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary view-optimization" data-optimization-id="${opt.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success apply-parameters" data-optimization-id="${opt.id}">
                                    <i class="fas fa-check"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                historyHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                contentContainer.innerHTML = historyHtml;
                
                // Add event listeners
                document.querySelectorAll('.view-optimization').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-optimization-id');
                        viewOptimizationDetails(id);
                    });
                });
                
                document.querySelectorAll('.apply-parameters').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-optimization-id');
                        applyOptimizationParameters(id, strategyId);
                    });
                });
            })
            .catch(error => {
                console.error('Error loading optimization history:', error);
                contentContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Failed to load optimization history. Please try again later.
                    </div>
                `;
            });
    }
    
    // View optimization details
    function viewOptimizationDetails(optimizationId) {
        // Implement viewing optimization details
        alert('View optimization ' + optimizationId + ' (Not implemented yet)');
    }
    
    // Apply optimization parameters to strategy
    function applyOptimizationParameters(optimizationId, strategyId) {
        // Implement applying optimization parameters
        alert('Apply parameters from optimization ' + optimizationId + ' to strategy ' + strategyId + ' (Not implemented yet)');
    }
</script>
{% endblock %}
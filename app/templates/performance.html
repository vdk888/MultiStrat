{% extends "layout.html" %}

{% block title %}Performance | Portfolio Management System{% endblock %}

{% block content %}
<!-- Page Title & Controls -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Performance Analytics</h1>
    <div class="d-flex">
        <div class="input-group me-2">
            <select id="performance-portfolio-selector" class="form-select form-select-sm">
                <option value="" selected disabled>Select Portfolio</option>
                <!-- Will be populated by JavaScript -->
            </select>
            <span class="input-group-text">Period</span>
            <select id="performance-period-selector" class="form-select form-select-sm">
                <option value="7">7 Days</option>
                <option value="30" selected>30 Days</option>
                <option value="90">90 Days</option>
                <option value="180">6 Months</option>
                <option value="365">1 Year</option>
            </select>
        </div>
        <button id="refresh-performance" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-sync-alt me-1"></i> Refresh
        </button>
    </div>
</div>

<!-- Performance Overview -->
<div class="row">
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h6 class="text-muted mb-2">Total Return</h6>
                <div class="d-flex align-items-center">
                    <div id="total-return" class="display-5 me-2">--</div>
                    <div id="total-return-change" class="fs-6"></div>
                </div>
                <div class="text-muted small mt-2">For selected period</div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h6 class="text-muted mb-2">Sharpe Ratio</h6>
                <div class="d-flex align-items-center">
                    <div id="sharpe-ratio" class="display-5 me-2">--</div>
                    <div id="sharpe-ratio-change" class="fs-6"></div>
                </div>
                <div class="text-muted small mt-2">Annualized</div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h6 class="text-muted mb-2">Maximum Drawdown</h6>
                <div class="d-flex align-items-center">
                    <div id="max-drawdown" class="display-5 me-2">--</div>
                    <div id="max-drawdown-change" class="fs-6"></div>
                </div>
                <div class="text-muted small mt-2">For selected period</div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h6 class="text-muted mb-2">Win Rate</h6>
                <div class="d-flex align-items-center">
                    <div id="win-rate" class="display-5 me-2">--</div>
                    <div id="win-rate-change" class="fs-6"></div>
                </div>
                <div class="text-muted small mt-2">Trade win/loss ratio</div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Charts -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Portfolio Value</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary active" data-chart-type="value">Value</button>
                    <button type="button" class="btn btn-outline-secondary" data-chart-type="return">Return</button>
                </div>
            </div>
            <div class="card-body">
                <div id="portfolio-value-container" class="chart-container" style="height: 400px;">
                    <canvas id="portfolio-value-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">Asset Allocation</h5>
            </div>
            <div class="card-body">
                <div id="asset-allocation-container" class="chart-container" style="height: 300px;">
                    <canvas id="asset-allocation-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">Monthly Returns</h5>
            </div>
            <div class="card-body">
                <div id="monthly-returns-container" class="chart-container" style="height: 300px;">
                    <canvas id="monthly-returns-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Metrics -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">Advanced Metrics</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Value</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Sharpe Ratio</td>
                                <td id="advanced-sharpe">--</td>
                                <td>Risk-adjusted return (excess return per unit of volatility)</td>
                            </tr>
                            <tr>
                                <td>Sortino Ratio</td>
                                <td id="advanced-sortino">--</td>
                                <td>Return per unit of downside risk</td>
                            </tr>
                            <tr>
                                <td>Calmar Ratio</td>
                                <td id="advanced-calmar">--</td>
                                <td>Return per unit of maximum drawdown</td>
                            </tr>
                            <tr>
                                <td>Volatility (Annualized)</td>
                                <td id="advanced-volatility">--</td>
                                <td>Standard deviation of returns (annualized)</td>
                            </tr>
                            <tr>
                                <td>CAGR</td>
                                <td id="advanced-cagr">--</td>
                                <td>Compound Annual Growth Rate</td>
                            </tr>
                            <tr>
                                <td>Average Daily Return</td>
                                <td id="advanced-avg-daily">--</td>
                                <td>Mean daily return</td>
                            </tr>
                            <tr>
                                <td>Positive Days</td>
                                <td id="advanced-positive-days">--</td>
                                <td>Percentage of days with positive returns</td>
                            </tr>
                            <tr>
                                <td>Value at Risk (95%)</td>
                                <td id="advanced-var">--</td>
                                <td>Daily loss that will not be exceeded with 95% confidence</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Trades -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Recent Trades</h5>
                <button class="btn btn-sm btn-outline-secondary" id="view-all-trades">
                    View All
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Asset</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Total</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recent-trades">
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading trades...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global chart references
    let portfolioValueChart = null;
    let assetAllocationChart = null;
    let monthlyReturnsChart = null;
    
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
        // Load portfolios for selector
        loadPortfolios();
        
        // Set up event listeners
        document.getElementById('refresh-performance')?.addEventListener('click', loadPerformanceData);
        
        document.getElementById('performance-portfolio-selector')?.addEventListener('change', loadPerformanceData);
        
        document.getElementById('performance-period-selector')?.addEventListener('change', loadPerformanceData);
        
        // Chart type toggle buttons
        document.querySelectorAll('[data-chart-type]').forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                document.querySelectorAll('[data-chart-type]').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Update chart
                const chartType = this.getAttribute('data-chart-type');
                updatePortfolioChart(chartType);
            });
        });
        
        // View all trades button
        document.getElementById('view-all-trades')?.addEventListener('click', function() {
            const portfolioId = document.getElementById('performance-portfolio-selector')?.value;
            if (portfolioId) {
                window.location.href = `/portfolios/${portfolioId}/trades`;
            }
        });
    });
    
    // Load portfolios for selector
    function loadPortfolios() {
        fetch('/api/v1/portfolios?is_active=true')
            .then(response => response.json())
            .then(portfolios => {
                const selector = document.getElementById('performance-portfolio-selector');
                if (!selector) return;
                
                // Clear existing options (except first)
                while (selector.options.length > 1) {
                    selector.remove(1);
                }
                
                // Add options for each portfolio
                portfolios.forEach(portfolio => {
                    const option = document.createElement('option');
                    option.value = portfolio.id;
                    option.textContent = portfolio.name;
                    selector.appendChild(option);
                });
                
                // Select first portfolio by default and load data
                if (portfolios.length > 0) {
                    selector.value = portfolios[0].id;
                    loadPerformanceData();
                }
            })
            .catch(error => {
                console.error('Error loading portfolios:', error);
                showErrorMessage('Failed to load portfolios');
            });
    }
    
    // Load performance data
    function loadPerformanceData() {
        const portfolioId = document.getElementById('performance-portfolio-selector')?.value;
        const days = document.getElementById('performance-period-selector')?.value || 30;
        
        if (!portfolioId) {
            showErrorMessage('Please select a portfolio');
            return;
        }
        
        // Show loading state
        document.getElementById('total-return').textContent = '--';
        document.getElementById('sharpe-ratio').textContent = '--';
        document.getElementById('max-drawdown').textContent = '--';
        document.getElementById('win-rate').textContent = '--';
        
        document.getElementById('total-return-change').innerHTML = '';
        document.getElementById('sharpe-ratio-change').innerHTML = '';
        document.getElementById('max-drawdown-change').innerHTML = '';
        document.getElementById('win-rate-change').innerHTML = '';
        
        document.getElementById('advanced-sharpe').textContent = '--';
        document.getElementById('advanced-sortino').textContent = '--';
        document.getElementById('advanced-calmar').textContent = '--';
        document.getElementById('advanced-volatility').textContent = '--';
        document.getElementById('advanced-cagr').textContent = '--';
        document.getElementById('advanced-avg-daily').textContent = '--';
        document.getElementById('advanced-positive-days').textContent = '--';
        document.getElementById('advanced-var').textContent = '--';
        
        // Load performance metrics
        fetch(`/api/v1/portfolios/${portfolioId}/performance?limit=${days}`)
            .then(response => response.json())
            .then(metrics => {
                updatePerformanceMetrics(metrics);
                
                // Get portfolio assets for allocation chart
                return fetch(`/api/v1/portfolios/${portfolioId}/assets`)
                    .then(response => response.json())
                    .then(assets => {
                        updateAssetAllocationChart(assets);
                    });
            })
            .catch(error => {
                console.error('Error loading performance data:', error);
                showErrorMessage('Failed to load performance data');
            });
        
        // Load recent trades
        fetch(`/api/v1/portfolios/${portfolioId}/trades?limit=10`)
            .then(response => response.json())
            .then(trades => {
                updateRecentTrades(trades);
            })
            .catch(error => {
                console.error('Error loading trades:', error);
                document.getElementById('recent-trades').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="text-muted">Failed to load trades</div>
                        </td>
                    </tr>
                `;
            });
    }
    
    // Update performance metrics display
    function updatePerformanceMetrics(metrics) {
        if (!metrics || metrics.length === 0) {
            showErrorMessage('No performance data available for the selected period');
            return;
        }
        
        // Get latest metrics
        const latest = metrics[metrics.length - 1];
        
        // Update overview metrics
        document.getElementById('total-return').textContent = formatNumber(latest.total_return, 2) + '%';
        document.getElementById('sharpe-ratio').textContent = formatNumber(latest.sharpe_ratio, 2);
        document.getElementById('max-drawdown').textContent = formatNumber(latest.max_drawdown, 2) + '%';
        document.getElementById('win-rate').textContent = formatNumber(latest.win_rate, 2) + '%';
        
        // Add change indicators if we have enough data
        if (metrics.length > 1) {
            const previous = metrics[metrics.length - 2];
            
            // Calculate changes
            const totalReturnChange = latest.total_return - previous.total_return;
            const sharpeRatioChange = latest.sharpe_ratio - previous.sharpe_ratio;
            const maxDrawdownChange = latest.max_drawdown - previous.max_drawdown;
            const winRateChange = latest.win_rate - previous.win_rate;
            
            // Update change displays
            document.getElementById('total-return-change').innerHTML = createChangeDisplay(totalReturnChange, '%');
            document.getElementById('sharpe-ratio-change').innerHTML = createChangeDisplay(sharpeRatioChange);
            document.getElementById('max-drawdown-change').innerHTML = createChangeDisplay(-maxDrawdownChange, '%'); // Negative because lower is better
            document.getElementById('win-rate-change').innerHTML = createChangeDisplay(winRateChange, '%');
        }
        
        // Update advanced metrics if available in additional_metrics
        if (latest.additional_metrics) {
            document.getElementById('advanced-sharpe').textContent = formatNumber(latest.sharpe_ratio, 2);
            document.getElementById('advanced-sortino').textContent = formatNumber(latest.additional_metrics.sortino_ratio || 0, 2);
            document.getElementById('advanced-calmar').textContent = formatNumber(latest.additional_metrics.calmar_ratio || 0, 2);
            document.getElementById('advanced-volatility').textContent = formatNumber(latest.additional_metrics.volatility || 0, 2) + '%';
            document.getElementById('advanced-cagr').textContent = formatNumber(latest.additional_metrics.cagr || 0, 2) + '%';
            document.getElementById('advanced-avg-daily').textContent = formatNumber(latest.additional_metrics.avg_daily_return || 0, 3) + '%';
            document.getElementById('advanced-positive-days').textContent = formatNumber(latest.additional_metrics.positive_days || 0, 1) + '%';
            document.getElementById('advanced-var').textContent = formatNumber(latest.additional_metrics.var_95 || 0, 2) + '%';
        }
        
        // Update portfolio value chart
        updatePortfolioValueChart(metrics);
        
        // Update monthly returns chart
        updateMonthlyReturnsChart(metrics);
    }
    
    // Create change display with up/down arrow
    function createChangeDisplay(change, suffix = '') {
        if (Math.abs(change) < 0.01) {
            return `<span class="text-muted">(0.00${suffix})</span>`;
        }
        
        const isPositive = change > 0;
        const icon = isPositive ? 'fa-arrow-up' : 'fa-arrow-down';
        const colorClass = isPositive ? 'text-success' : 'text-danger';
        
        return `<span class="${colorClass}">
                    <i class="fas ${icon} me-1"></i>${formatNumber(Math.abs(change), 2)}${suffix}
                </span>`;
    }
    
    // Update portfolio value chart
    function updatePortfolioValueChart(metrics) {
        const ctx = document.getElementById('portfolio-value-chart');
        if (!ctx) return;
        
        const dates = metrics.map(m => new Date(m.timestamp));
        const values = metrics.map(m => m.additional_metrics?.portfolio_value || 0);
        const returns = metrics.map(m => m.total_return);
        
        // Determine which dataset to show
        const chartType = document.querySelector('[data-chart-type].active')?.getAttribute('data-chart-type') || 'value';
        const data = chartType === 'value' ? values : returns;
        const label = chartType === 'value' ? 'Portfolio Value ($)' : 'Total Return (%)';
        
        // Destroy existing chart if it exists
        if (portfolioValueChart) {
            portfolioValueChart.destroy();
        }
        
        // Create new chart
        portfolioValueChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: label,
                    data: data,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    pointRadius: 0,
                    borderWidth: 2,
                    tension: 0.2,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            tooltipFormat: 'MMM d, yyyy'
                        }
                    },
                    y: {
                        beginAtZero: chartType === 'return'
                    }
                },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    },
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    // Update asset allocation chart
    function updateAssetAllocationChart(assets) {
        const ctx = document.getElementById('asset-allocation-chart');
        if (!ctx || !assets || assets.length === 0) return;
        
        // Prepare data
        const labels = assets.map(a => a.asset?.symbol || `Asset ${a.asset_id}`);
        const data = assets.map(a => a.current_allocation * 100);
        
        // Generate colors
        const backgroundColors = generateColors(assets.length);
        
        // Destroy existing chart if it exists
        if (assetAllocationChart) {
            assetAllocationChart.destroy();
        }
        
        // Create new chart
        assetAllocationChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    borderWidth: 1,
                    borderColor: 'rgba(255, 255, 255, 0.5)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 12,
                            padding: 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                return `${context.label}: ${formatNumber(value, 1)}%`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Update monthly returns chart
    function updateMonthlyReturnsChart(metrics) {
        const ctx = document.getElementById('monthly-returns-chart');
        if (!ctx || !metrics || metrics.length === 0) return;
        
        // Group metrics by month
        const monthlyReturns = {};
        
        metrics.forEach(metric => {
            const date = new Date(metric.timestamp);
            const monthYear = `${date.getFullYear()}-${date.getMonth() + 1}`;
            
            if (!monthlyReturns[monthYear]) {
                monthlyReturns[monthYear] = {
                    month: new Date(date.getFullYear(), date.getMonth(), 1),
                    return: 0
                };
            }
            
            // Use daily return to aggregate
            if (metric.daily_return) {
                monthlyReturns[monthYear].return += metric.daily_return;
            }
        });
        
        // Convert to arrays for chart
        const months = Object.values(monthlyReturns).map(m => m.month);
        const returns = Object.values(monthlyReturns).map(m => m.return);
        
        // Generate colors based on return value
        const colors = returns.map(value => value >= 0 ? 
            'rgba(75, 192, 192, 0.7)' : 'rgba(255, 99, 132, 0.7)');
        
        // Destroy existing chart if it exists
        if (monthlyReturnsChart) {
            monthlyReturnsChart.destroy();
        }
        
        // Create new chart
        monthlyReturnsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [{
                    label: 'Monthly Return (%)',
                    data: returns,
                    backgroundColor: colors,
                    borderColor: colors.map(c => c.replace('0.7', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'month',
                            displayFormats: {
                                month: 'MMM yy'
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Return (%)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Return: ${formatNumber(context.raw, 2)}%`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Update portfolio chart type (value or return)
    function updatePortfolioChart(chartType) {
        const portfolioId = document.getElementById('performance-portfolio-selector')?.value;
        const days = document.getElementById('performance-period-selector')?.value || 30;
        
        if (!portfolioId) return;
        
        fetch(`/api/v1/portfolios/${portfolioId}/performance?limit=${days}`)
            .then(response => response.json())
            .then(metrics => {
                const dates = metrics.map(m => new Date(m.timestamp));
                const values = metrics.map(m => m.additional_metrics?.portfolio_value || 0);
                const returns = metrics.map(m => m.total_return);
                
                const data = chartType === 'value' ? values : returns;
                const label = chartType === 'value' ? 'Portfolio Value ($)' : 'Total Return (%)';
                
                if (portfolioValueChart) {
                    portfolioValueChart.data.datasets[0].data = data;
                    portfolioValueChart.data.datasets[0].label = label;
                    portfolioValueChart.options.scales.y.beginAtZero = chartType === 'return';
                    portfolioValueChart.update();
                }
            })
            .catch(error => {
                console.error('Error updating chart:', error);
            });
    }
    
    // Update recent trades table
    function updateRecentTrades(trades) {
        const container = document.getElementById('recent-trades');
        if (!container) return;
        
        if (!trades || trades.length === 0) {
            container.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="text-muted">No recent trades found</div>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Create HTML for each trade
        const tradesHtml = trades.map(trade => {
            const totalCost = (trade.price * trade.quantity) + (trade.trade_costs || 0);
            
            return `
                <tr>
                    <td>${new Date(trade.timestamp).toLocaleString()}</td>
                    <td>${trade.asset?.symbol || `Asset #${trade.asset_id}`}</td>
                    <td>
                        <span class="badge ${trade.side.toLowerCase() === 'buy' ? 'bg-success' : 'bg-danger'}">
                            ${trade.side}
                        </span>
                    </td>
                    <td>${formatNumber(trade.quantity, 4)}</td>
                    <td>$${formatNumber(trade.price, 2)}</td>
                    <td>$${formatNumber(totalCost, 2)}</td>
                    <td>
                        <span class="badge ${trade.status === 'filled' ? 'bg-success' : 
                                          trade.status === 'pending' ? 'bg-warning' : 
                                          trade.status === 'failed' ? 'bg-danger' : 'bg-secondary'}">
                            ${trade.status}
                        </span>
                    </td>
                </tr>
            `;
        }).join('');
        
        container.innerHTML = tradesHtml;
    }
    
    // Generate random colors for charts
    function generateColors(count) {
        const baseColors = [
            'rgba(75, 192, 192, 0.7)',  // Teal
            'rgba(54, 162, 235, 0.7)',  // Blue
            'rgba(153, 102, 255, 0.7)', // Purple
            'rgba(255, 159, 64, 0.7)',  // Orange
            'rgba(255, 99, 132, 0.7)',  // Red
            'rgba(255, 205, 86, 0.7)',  // Yellow
            'rgba(201, 203, 207, 0.7)', // Grey
            'rgba(75, 192, 255, 0.7)',  // Light blue
            'rgba(153, 204, 153, 0.7)', // Light green
            'rgba(255, 153, 204, 0.7)'  // Pink
        ];
        
        // If we need more colors than in our base set, generate them
        if (count <= baseColors.length) {
            return baseColors.slice(0, count);
        }
        
        // Otherwise generate random colors
        const colors = [...baseColors];
        for (let i = baseColors.length; i < count; i++) {
            const r = Math.floor(Math.random() * 255);
            const g = Math.floor(Math.random() * 255);
            const b = Math.floor(Math.random() * 255);
            colors.push(`rgba(${r}, ${g}, ${b}, 0.7)`);
        }
        
        return colors;
    }
</script>
{% endblock %}